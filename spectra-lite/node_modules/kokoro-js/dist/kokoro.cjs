"use strict";var e=require("@huggingface/transformers"),a=require("phonemizer"),r=require("path"),l=require("fs/promises");function n(e){if(e.includes("."))return e;if(e.includes(":")){let[a,r]=e.split(":").map(Number);return 0===r?`${a} o'clock`:r<10?`${a} oh ${r}`:`${a} ${r}`}let a=parseInt(e.slice(0,4),10);if(a<1100||a%1e3<10)return e;let r=e.slice(0,2),l=parseInt(e.slice(2,4),10),n=e.endsWith("s")?"s":"";if(a%1e3>=100&&a%1e3<=999){if(0===l)return`${r} hundred${n}`;if(l<10)return`${r} oh ${l}${n}`}return`${r} ${l}${n}`}function t(e){const a="$"===e[0]?"dollar":"pound";if(isNaN(Number(e.slice(1))))return`${e.slice(1)} ${a}s`;if(!e.includes(".")){let r="1"===e.slice(1)?"":"s";return`${e.slice(1)} ${a}${r}`}const[r,l]=e.slice(1).split("."),n=parseInt(l.padEnd(2,"0"),10);return`${r} ${a}${"1"===r?"":"s"} and ${n} ${"$"===e[0]?1===n?"cent":"cents":1===n?"penny":"pence"}`}function i(e){let[a,r]=e.split(".");return`${a} point ${r.split("").join(" ")}`}const g=new RegExp(`(\\s*[${o=';:,.!?¡¿—…"«»“”(){}[]',o.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}]+\\s*)+`,"g");var o;async function c(e,r="a",l=!0){l&&(e=function(e){return e.replace(/[‘’]/g,"'").replace(/«/g,"“").replace(/»/g,"”").replace(/[“”]/g,'"').replace(/\(/g,"«").replace(/\)/g,"»").replace(/、/g,", ").replace(/。/g,". ").replace(/！/g,"! ").replace(/，/g,", ").replace(/：/g,": ").replace(/；/g,"; ").replace(/？/g,"? ").replace(/[^\S \n]/g," ").replace(/  +/," ").replace(/(?<=\n) +(?=\n)/g,"").replace(/\bD[Rr]\.(?= [A-Z])/g,"Doctor").replace(/\b(?:Mr\.|MR\.(?= [A-Z]))/g,"Mister").replace(/\b(?:Ms\.|MS\.(?= [A-Z]))/g,"Miss").replace(/\b(?:Mrs\.|MRS\.(?= [A-Z]))/g,"Mrs").replace(/\betc\.(?! [A-Z])/gi,"etc").replace(/\b(y)eah?\b/gi,"$1e'a").replace(/\d*\.\d+|\b\d{4}s?\b|(?<!:)\b(?:[1-9]|1[0-2]):[0-5]\d\b(?!:)/g,n).replace(/(?<=\d),(?=\d)/g,"").replace(/[$£]\d+(?:\.\d+)?(?: hundred| thousand| (?:[bm]|tr)illion)*\b|[$£]\d+\.\d\d?\b/gi,t).replace(/\d*\.\d+/g,i).replace(/(?<=\d)-(?=\d)/g," to ").replace(/(?<=\d)S/g," S").replace(/(?<=[BCDFGHJ-NP-TV-Z])'?s\b/g,"'S").replace(/(?<=X')S\b/g,"s").replace(/(?:[A-Za-z]\.){2,} [a-z]/g,(e=>e.replace(/\./g,"-"))).replace(/(?<=[A-Z])\.(?=[A-Z])/gi,"-").trim()}(e));const o=function(e,a){const r=[];let l=0;for(const n of e.matchAll(a)){const a=n[0];l<n.index&&r.push({match:!1,text:e.slice(l,n.index)}),a.length>0&&r.push({match:!0,text:a}),l=n.index+a.length}return l<e.length&&r.push({match:!1,text:e.slice(l)}),r}(e,g),c="a"===r?"en-us":"en",s=(await Promise.all(o.map((async({match:e,text:r})=>e?r:(await a.phonemize(r,c)).join(" "))))).join("");let u=s.replace(/kəkˈoːɹoʊ/g,"kˈoʊkəɹoʊ").replace(/kəkˈɔːɹəʊ/g,"kˈəʊkəɹəʊ").replace(/ʲ/g,"j").replace(/r/g,"ɹ").replace(/x/g,"k").replace(/ɬ/g,"l").replace(/(?<=[a-zɹː])(?=hˈʌndɹɪd)/g," ").replace(/ z(?=[;:,.!?¡¿—…"«»“” ]|$)/g,"z");return"a"===r&&(u=u.replace(/(?<=nˈaɪn)ti(?!ː)/g,"di")),u.trim()}const s=Object.freeze({af_heart:{name:"Heart",language:"en-us",gender:"Female",traits:"❤️",targetQuality:"A",overallGrade:"A"},af_alloy:{name:"Alloy",language:"en-us",gender:"Female",targetQuality:"B",overallGrade:"C"},af_aoede:{name:"Aoede",language:"en-us",gender:"Female",targetQuality:"B",overallGrade:"C+"},af_bella:{name:"Bella",language:"en-us",gender:"Female",traits:"🔥",targetQuality:"A",overallGrade:"A-"},af_jessica:{name:"Jessica",language:"en-us",gender:"Female",targetQuality:"C",overallGrade:"D"},af_kore:{name:"Kore",language:"en-us",gender:"Female",targetQuality:"B",overallGrade:"C+"},af_nicole:{name:"Nicole",language:"en-us",gender:"Female",traits:"🎧",targetQuality:"B",overallGrade:"B-"},af_nova:{name:"Nova",language:"en-us",gender:"Female",targetQuality:"B",overallGrade:"C"},af_river:{name:"River",language:"en-us",gender:"Female",targetQuality:"C",overallGrade:"D"},af_sarah:{name:"Sarah",language:"en-us",gender:"Female",targetQuality:"B",overallGrade:"C+"},af_sky:{name:"Sky",language:"en-us",gender:"Female",targetQuality:"B",overallGrade:"C-"},am_adam:{name:"Adam",language:"en-us",gender:"Male",targetQuality:"D",overallGrade:"F+"},am_echo:{name:"Echo",language:"en-us",gender:"Male",targetQuality:"C",overallGrade:"D"},am_eric:{name:"Eric",language:"en-us",gender:"Male",targetQuality:"C",overallGrade:"D"},am_fenrir:{name:"Fenrir",language:"en-us",gender:"Male",targetQuality:"B",overallGrade:"C+"},am_liam:{name:"Liam",language:"en-us",gender:"Male",targetQuality:"C",overallGrade:"D"},am_michael:{name:"Michael",language:"en-us",gender:"Male",targetQuality:"B",overallGrade:"C+"},am_onyx:{name:"Onyx",language:"en-us",gender:"Male",targetQuality:"C",overallGrade:"D"},am_puck:{name:"Puck",language:"en-us",gender:"Male",targetQuality:"B",overallGrade:"C+"},am_santa:{name:"Santa",language:"en-us",gender:"Male",targetQuality:"C",overallGrade:"D-"},bf_emma:{name:"Emma",language:"en-gb",gender:"Female",traits:"🚺",targetQuality:"B",overallGrade:"B-"},bf_isabella:{name:"Isabella",language:"en-gb",gender:"Female",targetQuality:"B",overallGrade:"C"},bm_george:{name:"George",language:"en-gb",gender:"Male",targetQuality:"B",overallGrade:"C"},bm_lewis:{name:"Lewis",language:"en-gb",gender:"Male",targetQuality:"C",overallGrade:"D+"},bf_alice:{name:"Alice",language:"en-gb",gender:"Female",traits:"🚺",targetQuality:"C",overallGrade:"D"},bf_lily:{name:"Lily",language:"en-gb",gender:"Female",traits:"🚺",targetQuality:"C",overallGrade:"D"},bm_daniel:{name:"Daniel",language:"en-gb",gender:"Male",traits:"🚹",targetQuality:"C",overallGrade:"D"},bm_fable:{name:"Fable",language:"en-gb",gender:"Male",traits:"🚹",targetQuality:"B",overallGrade:"C"}});const u=new Map;async function d(e){if(u.has(e))return u.get(e);const a=new Float32Array(await async function(e){if(l?.readFile){const a="undefined"!=typeof __dirname?__dirname:void 0,n=r.resolve(a,`../voices/${e}.bin`),{buffer:t}=await l.readFile(n);return t}const a=`https://huggingface.co/onnx-community/Kokoro-82M-v1.0-ONNX/resolve/main/voices/${e}.bin`;let n;try{n=await caches.open("kokoro-voices");const e=await n.match(a);if(e)return await e.arrayBuffer()}catch(e){console.warn("Unable to open cache",e)}const t=await fetch(a),i=await t.arrayBuffer();if(n)try{await n.put(a,new Response(i,{headers:t.headers}))}catch(e){console.warn("Unable to cache file",e)}return i}(e));return u.set(e,a),a}class m{constructor(e,a){this.model=e,this.tokenizer=a}static async from_pretrained(a,{dtype:r="fp32",device:l=null,progress_callback:n=null}={}){const t=e.StyleTextToSpeech2Model.from_pretrained(a,{progress_callback:n,dtype:r,device:l}),i=e.AutoTokenizer.from_pretrained(a,{progress_callback:n}),g=await Promise.all([t,i]);return new m(...g)}get voices(){return s}list_voices(){console.table(s)}_validate_voice(e){if(!s.hasOwnProperty(e))throw console.error(`Voice "${e}" not found. Available voices:`),console.table(s),new Error(`Voice "${e}" not found. Should be one of: ${Object.keys(s).join(", ")}.`)}async generate(a,{voice:r="af_heart",speed:l=1}={}){this._validate_voice(r);const n=r.at(0),t=await c(a,n),{input_ids:i}=this.tokenizer(t,{truncation:!0}),g=256*Math.min(Math.max(i.dims.at(-1)-2,0),509),o=(await d(r)).slice(g,g+256),s={input_ids:i,style:new e.Tensor("float32",o,[1,256]),speed:new e.Tensor("float32",[l],[1])},{waveform:u}=await this.model(s);return new e.RawAudio(u.data,24e3)}}exports.KokoroTTS=m;
